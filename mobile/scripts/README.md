# 管理者スクリプト

## 概要

FailShareプロジェクトの管理者向けスクリプト集です。データベースの初期化、サンプルデータ投入、環境管理を効率的に行います。

## 3段階デプロイフロー

### 1. 開発環境（dev）
```bash
npm run seed-data:dev
```
- 最小限のテストデータ
- フレンド機能データを含む
- 開発・デバッグ用

### 2. ステージング環境（staging）
```bash
npm run seed-data:staging
```
- 中規模のテストデータ
- フレンド機能データを含む
- 統合テスト用

### 3. 本番環境（prod）
```bash
npm run seed-data:prod -- --confirm
```
- 本格的なデータセット
- フレンド機能データを含む
- 最小限の変更のみ
- 事前承認必須
- フレンド機能の本番運用

## 環境別データセット

| 環境 | ユーザー数 | フレンド関係数 | リクエスト数 | 投稿数 | コメント数 |
|------|------------|----------------|--------------|--------|------------|
| dev | 5 | 8 | 3 | 10 | 15 |
| staging | 20 | 35 | 12 | 50 | 80 |
| prod | 100+ | 200+ | 50+ | 300+ | 500+ |

## 機能

- ✅ 多環境対応
- ✅ データ整合性保証
- ✅ フレンド機能対応
- ✅ エラーハンドリング
- ✅ ログ出力
- ✅ データ検証

## 投入されるデータ

### users コレクション
- 匿名ユーザープロフィール
- 表示名、アバター、参加日時
- 統計情報（投稿数、コメント数、いいね数など）

### friendships コレクション
- 双方向のフレンド関係
- ステータス（accepted）
- 作成日時、承認日時

### friendRequests コレクション
- フレンドリクエスト
- 送信者・受信者情報
- ステータス（pending, accepted, rejected）
- メッセージ、作成日時

### friendRecommendations コレクション
- フレンド推薦データ
- 推薦スコア、共通の興味
- 相互フレンド数

### stories コレクション
- 失敗談投稿
- カテゴリ、感情、学習内容
- メタデータ（閲覧数、いいね数など）

## フレンド機能テストデータ

### サンプルユーザー構成
```
ユーザーA (田中太郎) ←→ ユーザーB (佐藤花子)
    ↓                      ↓
ユーザーC (山田次郎) ←→ ユーザーD (鈴木美咲
    ↓                      ↓
ユーザーE (高橋健一) ←→ ユーザーF (渡辺愛
```

### フレンド関係
- A ↔ B (相互フレンド)
- C ↔ D (相互フレンド)
- E ↔ F (相互フレンド)
- A → C (リクエスト送信済み)
- D → E (リクエスト送信済み)

### フレンドリクエスト
- A → C: "よろしくお願いします！"
- D → E: "失敗談を共有しましょう"
- F → A: "同じカテゴリの投稿が面白いです"

### フレンド推薦
- 共通の興味を持つユーザー
- 相互フレンドが多いユーザー
- アクティブなユーザー

## フレンド機能テスト方法

### 基本的なテストフロー
1. アプリ起動・ログイン
2. プロフィール画面で「フレンド」をタップ
3. フレンド一覧の確認
4. フレンドリクエスト画面の確認
5. フレンド検索・推薦画面の確認

### 具体的なテストシナリオ

#### 1. フレンド一覧テスト
- [ ] フレンドが正しく表示される
- [ ] フレンド数が正しくカウントされる
- [ ] フレンドリクエストバッジが表示される
- [ ] フレンド削除機能が動作する
- [ ] フレンドブロック機能が動作する

#### 2. フレンドリクエストテスト
- [ ] 受信リクエストが表示される
- [ ] 送信リクエストが表示される
- [ ] リクエスト承認機能が動作する
- [ ] リクエスト拒否機能が動作する
- [ ] リクエスト送信機能が動作する

#### 3. フレンド検索・推薦テスト
- [ ] 推薦ユーザーが表示される
- [ ] フレンドリクエスト送信が動作する
- [ ] 既存フレンドは除外される
- [ ] ブロックユーザーは除外される
- [ ] 自分自身は除外される

#### 4. フレンドリクエスト送信・承認・拒否テスト
- [ ] 新しいリクエストを送信
- [ ] 受信したリクエストを承認
- [ ] 受信したリクエストを拒否
- [ ] フレンド一覧に反映される
- [ ] リクエスト一覧から削除される

## Firebase Consoleでのセキュリティルール更新

### 手動更新手順

1. **Firebase Consoleにアクセス**
   - https://console.firebase.google.com/
   - プロジェクト「failshare-dev」を選択

2. **Firestore Databaseに移動**
   - 左メニューから「Firestore Database」を選択
   - 「ルール」タブをクリック

3. **ルールを更新**
   - 現在のルールをすべて削除
   - `mobile/firestore.rules`の内容をコピー&ペースト
   - 「公開」ボタンをクリック
   - 更新完了まで数分待機

4. **インデックスを作成**
   - 「インデックス」タブをクリック
   - 「複合インデックスを作成」をクリック
   - 以下のインデックスを追加：

#### 必要なインデックス

**friendRequests コレクション**
- フィールド1: `status` (昇順)
- フィールド2: `toUserId` (昇順)
- フィールド3: `createdAt` (降順)

- フィールド1: `status` (昇順)
- フィールド2: `fromUserId` (昇順)
- フィールド3: `createdAt` (降順)

**friendships コレクション**
- フィールド1: `userId` (昇順)
- フィールド2: `createdAt` (降順)

- フィールド1: `friendId` (昇順)
- フィールド2: `createdAt` (降順)

**userBlocks コレクション**
- フィールド1: `userId` (昇順)
- フィールド2: `blockedUserId` (昇順)

**users コレクション**
- フィールド1: `id` (昇順)
- フィールド2: `createdAt` (降順)

- フィールド1: `displayName` (昇順)
- フィールド2: `createdAt` (降順)

### 自動更新（Firebase CLI使用時）

```bash
# Firebase CLIをインストール
npm install -g firebase-tools

# ログイン
firebase login

# プロジェクトを設定
firebase use failshare-dev

# セキュリティルールをデプロイ
firebase deploy --only firestore:rules

# インデックスをデプロイ
firebase deploy --only firestore:indexes
```

### トラブルシューティング

#### エラー: フレンド機能データが表示されない
- **原因**: セキュリティルールが正しく設定されていない
- **解決**: Firebase Consoleでルールを更新

#### エラー: インデックスが必要
- **原因**: 複合クエリにインデックスが不足
- **解決**: Firebase Consoleでインデックスを作成

#### エラー: 権限不足
- **原因**: セキュリティルールでアクセスが制限されている
- **解決**: ルールを確認・修正

#### エラー: データが重複する
- **原因**: スクリプトが複数回実行された
- **解決**: 既存データを削除してから再実行

#### エラー: フレンド推薦取得エラー: Missing or insufficient permissions
- **原因**: `anonymousUsers`コレクションの読み取り権限が不足
- **解決手順**:
  1. Firebase ConsoleでFirestore Database → ルールを開く
  2. `anonymousUsers`のルールを以下に変更：
  ```
  match /anonymousUsers/{userId} {
    allow read: if request.auth != null;
    allow write: if request.auth != null && request.auth.uid == userId;
  }
  ```
  3. 「公開」ボタンをクリック
  4. アプリを再起動してテスト

#### エラー: ルールの構文エラー
- **原因**: ルールファイルの構文が正しくない
- **解決**: 
  1. `mobile/firestore.rules`の構文を確認
  2. Firebase Consoleでルールをコピー&ペースト
  3. 「公開」ボタンをクリック

#### エラー: ルールの更新が反映されない
- **原因**: キャッシュや遅延の問題
- **解決**:
  1. 数分待機してから再試行
  2. アプリを完全に再起動
  3. ブラウザのキャッシュをクリア
  4. Firebase Consoleでルールが正しく保存されているか確認

## 環境管理のベストプラクティス

### 開発環境
- 頻繁なデータリセット
- 最小限のデータセット
- フレンド機能の基本テスト

### ステージング環境
- 本番に近いデータ量
- 統合テストの実行
- フレンド機能の詳細テスト

### 本番環境
- 慎重なデータ更新
- バックアップの作成
- フレンド機能の本格運用

## セキュリティ考慮事項

- 本番環境でのデータ投入は慎重に
- セキュリティルールの定期的な見直し
- フレンド機能のプライバシー保護
- ユーザーデータの適切な管理 