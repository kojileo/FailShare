rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ðŸ”’ å…¨ç’°å¢ƒçµ±ä¸€ãƒ«ãƒ¼ãƒ«ï¼ˆå€‹äººé–‹ç™ºå‘ã‘æœ€é©åŒ–ç‰ˆï¼‰
    
    // åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«
    match /anonymousUsers/{userId} {
      // èª­ã¿å–ã‚Šï¼šèªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åŸºæœ¬æƒ…å ±ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ï¼ˆãƒ•ãƒ¬ãƒ³ãƒ‰æŽ¨è–¦æ©Ÿèƒ½ã®ãŸã‚ï¼‰
      allow read: if request.auth != null;
      
      // æ›¸ãè¾¼ã¿ï¼šè‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®ã¿
      allow write: if request.auth != null && request.auth.uid == userId;
      
      // ãƒ•ãƒ¬ãƒ³ãƒ‰æ©Ÿèƒ½ã«ã‚ˆã‚‹çµ±è¨ˆæ›´æ–°ã‚’è¨±å¯ï¼ˆstats.friendsCountã®ã¿ï¼‰
      allow update: if request.auth != null 
                    && (request.auth.uid == userId || 
                        (request.auth.uid != userId && 
                         request.resource.data.stats.friendsCount is int &&
                         request.resource.data.stats.friendsCount >= 0));
    }
    
         // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ï¼ˆé€šå¸¸ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰
     match /users/{userId} {
       // èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ã€è‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
       allow read: if request.auth != null;
       allow write: if request.auth != null && request.auth.uid == userId;
     }
    
    // ã„ã„ã­æ©Ÿèƒ½
    match /likes/{likeId} {
      // èª­ã¿å–ã‚Šï¼šèªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿
      allow read: if request.auth != null;
      
      // ä½œæˆï¼šèªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ã€è‡ªåˆ†ã®ã„ã„ã­ã®ã¿
      allow create: if request.auth != null 
                    && request.auth.uid == request.resource.data.userId
                    && validateLikeData(request.resource.data);
      
      // å‰Šé™¤ï¼šè‡ªåˆ†ã®ã„ã„ã­ã®ã¿
      allow delete: if request.auth != null 
                    && request.auth.uid == resource.data.userId;
    }
    
    // æŠ•ç¨¿ã•ã‚ŒãŸå¤±æ•—è«‡
    match /stories/{storyId} {
      // èª­ã¿å–ã‚Šã¯èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿
      allow read: if request.auth != null;
      
      // ä½œæˆï¼šèªè¨¼æ¸ˆã¿ã€authorIdãŒä¸€è‡´ã€ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼é€šéŽã®å ´åˆã®ã¿
      allow create: if request.auth != null 
                    && request.auth.uid == request.resource.data.authorId
                    && validateStoryData(request.resource.data);
      
      // æ›´æ–°ï¼šæŠ•ç¨¿è€…ã®ã¿ã€ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ã‚‚å®Ÿè¡Œ
      allow update: if request.auth != null
                    && request.auth.uid == resource.data.authorId
                    && validateStoryUpdate(request.resource.data, resource.data);
      
      // å‰Šé™¤ï¼šæŠ•ç¨¿è€…ã®ã¿
      allow delete: if request.auth != null && request.auth.uid == resource.data.authorId;
    }
    
    // çµ±è¨ˆæƒ…å ±ã‚„ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°ï¼ˆé–²è¦§æ•°ã€å½¹ã«ç«‹ã£ãŸã‚«ã‚¦ãƒ³ãƒˆç­‰ï¼‰
    match /stories/{storyId} {
      // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°ï¼ˆé–²è¦§æ•°ã€å½¹ã«ç«‹ã£ãŸã‚«ã‚¦ãƒ³ãƒˆï¼‰ã¯èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿
      allow update: if request.auth != null
                    && onlyMetadataChanged(request.resource.data, resource.data);
    }
    
    // ã‚³ãƒ¡ãƒ³ãƒˆæ©Ÿèƒ½ï¼ˆç‹¬ç«‹ã—ãŸã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼‰
    match /comments/{commentId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null 
                    && request.auth.uid == request.resource.data.authorId
                    && validateCommentData(request.resource.data);
      allow update, delete: if request.auth != null 
                            && request.auth.uid == resource.data.authorId;
    }
    
    // ãƒ•ãƒ¬ãƒ³ãƒ‰æ©Ÿèƒ½
    match /friendships/{friendshipId} {
      allow read: if request.auth != null 
                  && (request.auth.uid == resource.data.userId || request.auth.uid == resource.data.friendId);
      allow create: if request.auth != null 
                    && validateFriendshipData(request.resource.data)
                    && (request.auth.uid == request.resource.data.userId || 
                        request.auth.uid == request.resource.data.friendId);
      allow delete: if request.auth != null 
                    && (request.auth.uid == resource.data.userId || request.auth.uid == resource.data.friendId);
    }
    
    // ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ©Ÿèƒ½
    match /friendRequests/{requestId} {
      allow read: if request.auth != null 
                  && (request.auth.uid == resource.data.fromUserId || request.auth.uid == resource.data.toUserId);
      allow create: if request.auth != null 
                    && request.auth.uid == request.resource.data.fromUserId
                    && validateFriendRequestData(request.resource.data);
      allow update: if request.auth != null 
                    && (request.auth.uid == resource.data.toUserId || request.auth.uid == resource.data.fromUserId)
                    && validateFriendRequestUpdate(request.resource.data, resource.data);
      allow delete: if request.auth != null 
                    && (request.auth.uid == resource.data.fromUserId || request.auth.uid == resource.data.toUserId);
    }

    // ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½
    match /chats/{chatId} {
      allow read: if request.auth != null 
                  && request.auth.uid in resource.data.participants;
      allow create: if request.auth != null 
                    && request.auth.uid in request.resource.data.participants
                    && validateChatData(request.resource.data);
      allow update: if request.auth != null 
                    && request.auth.uid in resource.data.participants
                    && validateChatUpdate(request.resource.data, resource.data);
      allow delete: if request.auth != null 
                    && request.auth.uid in resource.data.participants;
    }

         // ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ©Ÿèƒ½
     match /messages/{messageId} {
       allow read: if request.auth != null 
                   && request.auth.uid in get(/databases/$(database)/documents/chats/$(resource.data.chatId)).data.participants;
       allow create: if request.auth != null 
                     && request.auth.uid == request.resource.data.senderId
                     && request.auth.uid in get(/databases/$(database)/documents/chats/$(request.resource.data.chatId)).data.participants
                     && validateMessageData(request.resource.data);
       allow update: if request.auth != null 
                     && (request.auth.uid == resource.data.senderId || 
                         (request.auth.uid in get(/databases/$(database)/documents/chats/$(resource.data.chatId)).data.participants && 
                          request.resource.data.keys().hasAll(['isRead'])));
       allow delete: if request.auth != null 
                     && request.auth.uid == resource.data.senderId;
     }    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ–ãƒ­ãƒƒã‚¯æ©Ÿèƒ½
    match /userBlocks/{blockId} {
      allow read: if request.auth != null 
                  && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null 
                    && request.auth.uid == request.resource.data.userId
                    && validateUserBlockData(request.resource.data);
      allow delete: if request.auth != null 
                    && request.auth.uid == resource.data.userId;
    }
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆæƒ…å ±ã®æ›´æ–°æ¤œè¨¼ã¯ä¸Šè¨˜ã®anonymousUsersãƒ«ãƒ¼ãƒ«ã«çµ±åˆæ¸ˆã¿
    
    // é–‹ç™ºãƒ»ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ï¼ˆå…¨ç’°å¢ƒã§åˆ©ç”¨å¯èƒ½ï¼‰
    match /dev_tests/{document} {
      allow read, write: if request.auth != null;
    }
    
    match /staging_tests/{document} {
      allow read, write: if request.auth != null;
    }
    
    // ç®¡ç†è€…å°‚ç”¨ãƒ‡ãƒ¼ã‚¿ï¼ˆç®¡ç†è€…ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ï¼‰
    match /admin/{document=**} {
      allow read, write: if request.auth != null 
                         && request.auth.token.admin == true;
    }
    
    // ä»–ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’æ‹’å¦
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

// æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿ã®æ¤œè¨¼é–¢æ•°ï¼ˆéšŽå±¤ã‚«ãƒ†ã‚´ãƒªå¯¾å¿œç‰ˆï¼‰
function validateStoryData(data) {
  return data.keys().hasAll(['authorId', 'content', 'metadata']) &&
         data.content.keys().hasAll(['title', 'category', 'situation', 'action', 'result', 'learning', 'emotion']) &&
         data.metadata.keys().hasAll(['createdAt', 'viewCount', 'helpfulCount', 'commentCount', 'tags']) &&
         // ã‚¿ã‚¤ãƒˆãƒ«æ¤œè¨¼
         data.content.title is string &&
         data.content.title.size() >= 1 && data.content.title.size() <= 100 &&
         // éšŽå±¤ã‚«ãƒ†ã‚´ãƒªæ¤œè¨¼
         validateCategoryHierarchy(data.content.category) &&
         // å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è©³ç´°æ¤œè¨¼
         data.content.situation is string &&
         data.content.situation.size() >= 1 && data.content.situation.size() <= 280 &&
         data.content.action is string &&
         data.content.action.size() >= 1 && data.content.action.size() <= 280 &&
         data.content.result is string &&
         data.content.result.size() >= 1 && data.content.result.size() <= 280 &&
         data.content.learning is string &&
         data.content.learning.size() >= 1 && data.content.learning.size() <= 280 &&
         validateEmotion(data.content.emotion) &&
         // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ï¼ˆæ–°è¦æŠ•ç¨¿ã¯0ã‹ã‚‰é–‹å§‹ï¼‰
         data.metadata.viewCount is int && data.metadata.viewCount >= 0 &&
         data.metadata.helpfulCount is int && data.metadata.helpfulCount >= 0 &&
         data.metadata.commentCount is int && data.metadata.commentCount >= 0 &&
         data.metadata.tags is list && data.metadata.tags.size() <= 10 &&
         data.metadata.createdAt is timestamp;
}

// éšŽå±¤ã‚«ãƒ†ã‚´ãƒªã®æ¤œè¨¼é–¢æ•°
function validateCategoryHierarchy(category) {
  // ç©ºã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚„nullã®å ´åˆã¯å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚è¨±å¯
  return category == null || 
         category.keys().size() == 0 ||
         (category.keys().hasAll(['main', 'sub']) &&
          validateMainCategory(category.main) &&
          validateSubCategory(category.main, category.sub));
}

// ãƒ¡ã‚¤ãƒ³ã‚«ãƒ†ã‚´ãƒªã®æ¤œè¨¼
function validateMainCategory(mainCategory) {
  return mainCategory == null || mainCategory == '' || mainCategory in ['æ‹æ„›', 'ä»•äº‹', 'ãã®ä»–'];
}

// ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªã®æ¤œè¨¼ï¼ˆãƒ¡ã‚¤ãƒ³ã‚«ãƒ†ã‚´ãƒªã«å¿œã˜ã¦ï¼‰
function validateSubCategory(mainCategory, subCategory) {
  return mainCategory == null || subCategory == null || subCategory == '' ||
         (mainCategory == 'æ‹æ„›' && subCategory in ['ãƒ‡ãƒ¼ãƒˆ', 'å‘Šç™½', 'ã‚«ãƒƒãƒ—ãƒ«', 'ç‰‡æƒ³ã„', 'åˆ¥ã‚Œ']) ||
         (mainCategory == 'ä»•äº‹' && subCategory in ['è·å ´äººé–“é–¢ä¿‚', 'è»¢è·ãƒ»ã‚­ãƒ£ãƒªã‚¢', 'ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ»ä¼šè­°', 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†', 'ã‚¹ã‚­ãƒ«ç¿’å¾—']) ||
         (mainCategory == 'ãã®ä»–' && subCategory == 'ãã®ä»–');
}

// æ„Ÿæƒ…ã®æ¤œè¨¼
function validateEmotion(emotion) {
  return emotion == null || emotion == '' || emotion in ['å¾Œæ‚”', 'æ¥ãšã‹ã—ã„', 'æ‚²ã—ã„', 'ä¸å®‰', 'æ€’ã‚Š', 'æ··ä¹±', 'ãã®ä»–'];
}

// ã‚³ãƒ¡ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã®æ¤œè¨¼é–¢æ•°
function validateCommentData(data) {
  return data.keys().hasAll(['authorId', 'content', 'createdAt']) &&
         data.content is string &&
         data.content.size() >= 1 && data.content.size() <= 500 &&
         data.authorId is string &&
         data.authorId == request.auth.uid &&
         data.createdAt is timestamp;
}

// æŠ•ç¨¿æ›´æ–°ãƒ‡ãƒ¼ã‚¿ã®æ¤œè¨¼é–¢æ•°
function validateStoryUpdate(newData, oldData) {
  return newData.authorId == oldData.authorId &&
         newData.metadata.createdAt == oldData.metadata.createdAt && // ä½œæˆæ—¥æ™‚ã¯å¤‰æ›´ä¸å¯
         validateStoryData(newData);
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆæ›´æ–°ã®æ¤œè¨¼
function validateUserStatsUpdate(newData, oldData) {
  // oldDataãŒå­˜åœ¨ã—ãªã„å ´åˆï¼ˆåˆå›žä½œæˆï¼‰ã‚‚è¨±å¯
  return (oldData == null || (
    newData.keys().hasAll(['stats']) &&
    newData.stats.keys().hasAll(['totalPosts', 'totalComments', 'helpfulVotes', 'learningPoints']) &&
    newData.stats.totalPosts is int && newData.stats.totalPosts >= 0 &&
    newData.stats.totalComments is int && newData.stats.totalComments >= 0 &&
    newData.stats.helpfulVotes is int && newData.stats.helpfulVotes >= 0 &&
    newData.stats.learningPoints is int && newData.stats.learningPoints >= 0
  ));
}

// ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ã¿ã®æ›´æ–°ã‹ã©ã†ã‹ã‚’ç¢ºèª
function onlyMetadataChanged(newData, oldData) {
  return newData.authorId == oldData.authorId &&
         newData.content == oldData.content &&
         newData.metadata.createdAt == oldData.metadata.createdAt && // ä½œæˆæ—¥æ™‚ã¯å¤‰æ›´ä¸å¯
         // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã¯å¢—åŠ ã®ã¿è¨±å¯
         (newData.metadata.viewCount >= oldData.metadata.viewCount ||
          newData.metadata.helpfulCount >= oldData.metadata.helpfulCount ||
          newData.metadata.commentCount >= oldData.metadata.commentCount);
} 

// ã„ã„ã­ãƒ‡ãƒ¼ã‚¿ã®æ¤œè¨¼é–¢æ•°
function validateLikeData(data) {
  return data.keys().hasAll(['storyId', 'userId', 'createdAt']) &&
         data.storyId is string &&
         data.storyId.size() > 0 &&
         data.userId is string &&
         data.userId == request.auth.uid &&
         data.createdAt is timestamp;
}

// ãƒ•ãƒ¬ãƒ³ãƒ‰ã‚·ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ã®æ¤œè¨¼é–¢æ•°
function validateFriendshipData(data) {
  return data.keys().hasAll(['userId', 'friendId', 'status', 'createdAt']) &&
         data.userId is string &&
         data.friendId is string &&
         data.friendId.size() > 0 &&
         data.userId != data.friendId &&
         data.status in ['pending', 'accepted', 'blocked'] &&
         data.createdAt is timestamp;
}

// ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®æ¤œè¨¼é–¢æ•°
function validateFriendRequestData(data) {
  return data.keys().hasAll(['fromUserId', 'toUserId', 'status', 'createdAt']) &&
         data.fromUserId is string &&
         data.fromUserId == request.auth.uid &&
         data.toUserId is string &&
         data.toUserId.size() > 0 &&
         data.fromUserId != data.toUserId &&
         data.status == 'pending' &&
         data.createdAt is timestamp;
}

// ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ›´æ–°ã®æ¤œè¨¼é–¢æ•°
function validateFriendRequestUpdate(newData, oldData) {
  return newData.fromUserId == oldData.fromUserId &&
         newData.toUserId == oldData.toUserId &&
         newData.createdAt == oldData.createdAt &&
         newData.status in ['pending', 'accepted', 'rejected'] &&
         (oldData.status == 'pending' || newData.status == oldData.status);
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ–ãƒ­ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã®æ¤œè¨¼é–¢æ•°
function validateUserBlockData(data) {
  return data.keys().hasAll(['userId', 'blockedUserId', 'createdAt']) &&
         data.userId is string &&
         data.userId == request.auth.uid &&
         data.blockedUserId is string &&
         data.blockedUserId.size() > 0 &&
         data.userId != data.blockedUserId &&
         data.createdAt is timestamp;
}

// ãƒãƒ£ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã®æ¤œè¨¼é–¢æ•°
function validateChatData(data) {
  return data.keys().hasAll(['participants', 'createdAt', 'updatedAt']) &&
         data.participants is list &&
         data.participants.size() == 2 &&
         request.auth.uid in data.participants &&
         data.createdAt is timestamp &&
         data.updatedAt is timestamp;
}

// ãƒãƒ£ãƒƒãƒˆæ›´æ–°ã®æ¤œè¨¼é–¢æ•°
function validateChatUpdate(newData, oldData) {
  return newData.participants == oldData.participants &&
         newData.createdAt == oldData.createdAt &&
         request.auth.uid in newData.participants;
}

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ‡ãƒ¼ã‚¿ã®æ¤œè¨¼é–¢æ•°
function validateMessageData(data) {
  return data.keys().hasAll(['chatId', 'senderId', 'content', 'messageType', 'createdAt']) &&
         data.chatId is string &&
         data.chatId.size() > 0 &&
         data.senderId is string &&
         data.senderId == request.auth.uid &&
         data.content is string &&
         data.content.size() >= 1 && data.content.size() <= 1000 &&
         data.messageType in ['text', 'image', 'file'] &&
         data.createdAt is timestamp;
}

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ›´æ–°ã®æ¤œè¨¼é–¢æ•°
function validateMessageUpdate(newData, oldData) {
  return newData.chatId == oldData.chatId &&
         newData.senderId == oldData.senderId &&
         newData.createdAt == oldData.createdAt &&
         newData.content is string &&
         newData.content.size() >= 1 && newData.content.size() <= 1000 &&
         newData.messageType in ['text', 'image', 'file'];
}

 